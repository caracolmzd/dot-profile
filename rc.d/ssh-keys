#!/bin/bash

# list configured hosts
alias ssh-hosts='awk "/^Host / {print \$2}" ~/.ssh/config'


#
# utils for ssh keys using fingerprints
#

# key store path, default to ~/.ssh
SSH_KEY_PATH=${SSH_KEY_PATH:-~/.ssh}

# allowed formats: md5, sha256
# set to md5 if not set by user:
FP_FORMAT=${FP_FORMAT:-md5}

ssh-key-fingerprint() {
    local key=$1
    local fp
    fp=$(ssh-keygen -l -E ${FP_FORMAT} -f $key)
    printf "%50s\t ${fp}\n" $key
}

# find key location by fingerprint
# find_key <fingerprint>
ssh-key-find() {
    echo 'FP_FORMAT: ' $FP_FORMAT ' # allowed formats: md5, sha256'
    echo 'SSH_KEY_PATH: ' $SSH_KEY_PATH
    local keys
    keys=$(find ${SSH_KEY_PATH} -maxdepth 1 -name '*.pub' -exec basename -s .pub {} \;)
    for k in $keys; do
        local fp
        fp=$(ssh-key-fingerprint ${SSH_KEY_PATH}/$k)
        if [[ $fp == *"$1"* ]]; then
            echo $fp
        fi
    done
}

# list ssh keys with fingerprints
ssh-key-list() {
    echo 'FP_FORMAT: ' $FP_FORMAT ' # allowed formats: md5, sha256'
    echo 'SSH_KEY_PATH: ' $SSH_KEY_PATH
    echo 

    local keys
    keys=$(find ${SSH_KEY_PATH} -maxdepth 1 -name '*.pub' -exec basename -s .pub {} \;)
    for k in $keys; do
        ssh-key-fingerprint ${SSH_KEY_PATH}/$k
    done
}

#
# SSH agent management using keychain
#

# Start SSH agent using keychain (only if not already running)
ssh-agent-start() {
    if ! command -v keychain >/dev/null 2>&1; then
        echo "Warning: keychain command not found. Please install keychain to use this function."
        return 1
    fi
    if [ -z "$SSH_AGENT_PID" ] || ! kill -0 $SSH_AGENT_PID 2>/dev/null; then
        eval $(keychain --eval --agents ssh --quiet)
        echo "SSH agent started."
    else
        echo "SSH agent already running (PID: $SSH_AGENT_PID)"
    fi
}

# Check if SSH agent is running
ssh-agent-check() {
    if [ -n "$SSH_AGENT_PID" ] && kill -0 $SSH_AGENT_PID 2>/dev/null; then
        echo "SSH agent is running (PID: $SSH_AGENT_PID)"
        echo "SSH agent has keys:"
        ssh-add -l
    else
        echo "SSH agent is not running"
    fi
}

# Stop the SSH agent
ssh-agent-stop() {
    if [ -n "$SSH_AGENT_PID" ] && kill -0 $SSH_AGENT_PID 2>/dev/null; then
        kill $SSH_AGENT_PID
        echo "SSH agent stopped."
        unset SSH_AGENT_PID SSH_AUTH_SOCK
    else
        echo "SSH agent is not running"
    fi
}
